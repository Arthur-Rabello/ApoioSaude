{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crie sua nova senha</title>
    <link rel="stylesheet" href="{% static 'css/register.css' %}">
    <link rel="icon" type="image/x-icon" href="{% static 'img/logo.png' %}">
</head>
<body>
    <div class="container">
        <h2>Digite sua nova senha</h2>
        <br>
        <form method="post">
            {% csrf_token %}
            <div class="form-group password-wrapper">
                <label for="{{ form.new_password1.id_for_label }}">Nova senha:</label>
                <div class="input-with-icon">
                    {{ form.new_password1 }}
                    <img src="{% static 'img/olho.png' %}" alt="Mostrar senha" class="toggle-password" tabindex="0" data-target="id_new_password1" />
                </div>
                <ul class="password-help" id="password-help-1">
                    <li class="invalid" id="password-criteria-1">Mínimo de 8 caracteres.</li>
                    <li class="invalid" id="password-criteria-2">Pelo menos uma letra maiúscula.</li>
                    <li class="invalid" id="password-criteria-3">Pelo menos uma letra minúscula.</li>
                    <li class="invalid" id="password-criteria-4">Pelo menos um número.</li>
                    <li class="invalid" id="password-criteria-5">Pelo menos um caractere especial.</li>
                </ul>
            </div>
            <br>
            <div class="form-group password-wrapper">
                <label for="{{ form.new_password2.id_for_label }}">Confirme a nova senha:</label>
                <div class="input-with-icon">
                    {{ form.new_password2 }}
                    <img src="{% static 'img/olho.png' %}" alt="Mostrar senha" class="toggle-password" tabindex="0" data-target="id_new_password2" />
                </div>
                <ul class="password-help" id="password-help-2">
                    <li class="invalid" id="password-criteria-match">As senhas devem coincidir.</li>
                </ul>
            </div>
            <br>
            <button type="submit" class="btn btn-primary">Alterar minha senha</button>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const password1 = document.getElementById('id_new_password1');
            const password2 = document.getElementById('id_new_password2');
            const helpText1 = document.getElementById('password-help-1');
            const helpText2 = document.getElementById('password-help-2');


            function validarSenhaSegura() {
                const valor = password1.value;
                const criterios = [
                    /.{8,}/,
                    /[A-Z]/,
                    /[a-z]/,
                    /[0-9]/,
                    /[^A-Za-z0-9]/
                ];

                criterios.forEach((regex, i) => {
                    const item = document.getElementById(`password-criteria-${i + 1}`);
                    if (regex.test(valor)) {
                        item.classList.add('valid');
                        item.classList.remove('invalid');
                    } else {
                        item.classList.add('invalid');
                        item.classList.remove('valid');
                    }
                });
            }

            function validarConfirmacao() {
                const item = document.getElementById('password-criteria-match');
                if (password1.value === password2.value && password1.value !== '') {
                    item.classList.add('valid');
                    item.classList.remove('invalid');
                } else {
                    item.classList.add('invalid');
                    item.classList.remove('valid');
                }
            }

            if (password1 && password2) {
                password1.addEventListener('input', () => {
                    validarSenhaSegura();
                    validarConfirmacao();
                });
                password2.addEventListener('input', validarConfirmacao);
            }

            if (password1 && helpText1) {
                password1.addEventListener('focus', function () {
                    helpText1.classList.add('visible');
                });
                password1.addEventListener('blur', function () {
                    helpText1.classList.remove('visible');
                });
            }

            if (password2 && helpText2) {
                password2.addEventListener('focus', function () {
                    helpText2.classList.add('visible');
                });
                password2.addEventListener('blur', function () {
                    helpText2.classList.remove('visible');
                });
            }

            const toggles = document.querySelectorAll('.toggle-password');
            toggles.forEach(function(toggle) {
                toggle.addEventListener('click', function () {
                    const targetId = this.getAttribute('data-target');
                    const input = document.getElementById(targetId);
                    if (!input) return;

                    const isPassword = input.getAttribute('type') === 'password';
                    input.setAttribute('type', isPassword ? 'text' : 'password');

                    this.src = isPassword ? "{% static 'img/olho (1).png' %}" : "{% static 'img/olho.png' %}";
                    this.alt = isPassword ? "Ocultar senha" : "Mostrar senha";
                });

                toggle.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        this.click();
                    }
                });
            });
        });
    </script>
</body>
</html>
